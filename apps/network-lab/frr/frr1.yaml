apiVersion: v1
kind: ConfigMap
metadata:
  name: frr1-config
  namespace: network-lab
data:
  daemons: |
    zebra=yes
    bgpd=yes
  vtysh.conf: |
    service integrated-vtysh-config
  frr.conf: |
    frr version 9.1
    frr defaults traditional
    hostname frr1
    log stdout

    ip route 10.1.0.0/24 Null0

    router bgp 65001
      bgp router-id 1.1.1.1
      no bgp ebgp-requires-policy
      !
      address-family ipv4 unicast
        network 10.1.0.0/24
      exit-address-family
    !
    line vty
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: frr1
  namespace: network-lab
  labels:
    app: frr1
spec:
  serviceName: frr1
  replicas: 1
  selector:
    matchLabels:
      app: frr1
  template:
    metadata:
      labels:
        app: frr1
      annotations:
        k8s.v1.cni.cncf.io/networks: '[{"name":"sriov-net-emulated","interface":"net1","ips":["172.30.0.11/24"]}]'
    spec:
      containers:
        - name: frr
          image: frrouting/frr:latest
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    set -eu

                    PEER_DNS="frr2-0.frr2.network-lab.svc.cluster.local"
                    PEER_ASN="65002"
                    LOCAL_ASN="65001"
                    MAX_RETRIES=60
                    STATIC_PEER_IP="172.30.0.12"
                    BGP_TRANSPORT="${BGP_TRANSPORT:-primary}"
                    TARGET_PEER_IP=""

                    vtysh -f /etc/frr/frr.conf >/dev/null 2>&1 || true

                    for i in $(seq 1 "${MAX_RETRIES}"); do
                      if vtysh -c "show bgp summary" >/dev/null 2>&1; then
                        break
                      fi
                      sleep 2
                    done

                    if [ "${BGP_TRANSPORT}" = "secondary" ] && ip -4 addr show dev net1 >/dev/null 2>&1; then
                      TARGET_PEER_IP="${STATIC_PEER_IP}"
                    else
                      for i in $(seq 1 "${MAX_RETRIES}"); do
                        TARGET_PEER_IP="$(getent hosts "${PEER_DNS}" | awk '{print $1}' | head -n1 || true)"
                        if [ -n "${TARGET_PEER_IP}" ]; then
                          break
                        fi
                        sleep 2
                      done
                    fi

                    if [ -z "${TARGET_PEER_IP}" ]; then
                      echo "failed to resolve peer ${PEER_DNS}"
                      exit 1
                    fi

                    for OLD_PEER_IP in $(vtysh -c "show running-config" | awk '/neighbor [0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+ remote-as 65002/{print $2}'); do
                      if [ "${OLD_PEER_IP}" != "${TARGET_PEER_IP}" ]; then
                        vtysh -c "conf t" -c "router bgp ${LOCAL_ASN}" -c "no neighbor ${OLD_PEER_IP} remote-as ${PEER_ASN}" -c "end" || true
                      fi
                    done

                    vtysh \
                      -c "conf t" \
                      -c "router bgp ${LOCAL_ASN}" \
                      -c "no bgp ebgp-requires-policy" \
                      -c "neighbor ${TARGET_PEER_IP} remote-as ${PEER_ASN}" \
                      -c "neighbor ${TARGET_PEER_IP} ebgp-multihop 2" \
                      -c "neighbor ${TARGET_PEER_IP} disable-connected-check" \
                      -c "neighbor ${TARGET_PEER_IP} timers 3 9" \
                      -c "neighbor ${TARGET_PEER_IP} soft-reconfiguration inbound" \
                      -c "address-family ipv4 unicast" \
                      -c "neighbor ${TARGET_PEER_IP} activate" \
                      -c "exit-address-family" \
                      -c "end"
          volumeMounts:
            - name: frr-config
              mountPath: /etc/frr/daemons
              subPath: daemons
            - name: frr-config
              mountPath: /etc/frr/frr.conf
              subPath: frr.conf
            - name: frr-config
              mountPath: /etc/frr/vtysh.conf
              subPath: vtysh.conf
            - name: captures
              mountPath: /captures
          env:
            - name: BGP_TRANSPORT
              value: primary
          ports:
            - name: bgp
              containerPort: 179
      volumes:
        - name: frr-config
          configMap:
            name: frr1-config
  volumeClaimTemplates:
    - metadata:
        name: captures
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: standard
        resources:
          requests:
            storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: frr1
  namespace: network-lab
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: frr1
  ports:
    - name: bgp
      port: 179
      targetPort: 179
