apiVersion: v1
kind: ConfigMap
metadata:
  name: frr1-config
  namespace: network-lab
data:
  daemons: |
    zebra=yes
    bgpd=yes
  vtysh.conf: |
    service integrated-vtysh-config
  frr.conf: |
    frr version 9.1
    frr defaults traditional
    hostname frr1
    log stdout

    router bgp 65001
      bgp router-id 1.1.1.1
      no bgp ebgp-requires-policy
      !
      address-family ipv4 unicast
        network 10.1.0.0/24
      exit-address-family
    !
    line vty
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: frr1
  namespace: network-lab
  labels:
    app: frr1
spec:
  serviceName: frr1
  replicas: 1
  selector:
    matchLabels:
      app: frr1
  template:
    metadata:
      labels:
        app: frr1
    spec:
      containers:
        - name: frr
          image: frrouting/frr:latest
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    set -eu

                    PEER_DNS="frr2-0.frr2.network-lab.svc.cluster.local"
                    PEER_ASN="65002"
                    LOCAL_ASN="65001"
                    MAX_RETRIES=60

                    vtysh -f /etc/frr/frr.conf >/dev/null 2>&1 || true

                    for i in $(seq 1 "${MAX_RETRIES}"); do
                      if vtysh -c "show bgp summary" >/dev/null 2>&1; then
                        break
                      fi
                      sleep 2
                    done

                    PEER_IP=""
                    for i in $(seq 1 "${MAX_RETRIES}"); do
                      PEER_IP="$(getent hosts "${PEER_DNS}" | awk '{print $1}' | head -n1 || true)"
                      if [ -n "${PEER_IP}" ]; then
                        break
                      fi
                      sleep 2
                    done

                    if [ -z "${PEER_IP}" ]; then
                      echo "failed to resolve peer ${PEER_DNS}"
                      exit 1
                    fi

                    vtysh \
                      -c "conf t" \
                      -c "router bgp ${LOCAL_ASN}" \
                      -c "no bgp ebgp-requires-policy" \
                      -c "neighbor ${PEER_IP} remote-as ${PEER_ASN}" \
                      -c "neighbor ${PEER_IP} ebgp-multihop 2" \
                      -c "neighbor ${PEER_IP} disable-connected-check" \
                      -c "neighbor ${PEER_IP} timers 3 9" \
                      -c "neighbor ${PEER_IP} soft-reconfiguration inbound" \
                      -c "address-family ipv4 unicast" \
                      -c "neighbor ${PEER_IP} activate" \
                      -c "exit-address-family" \
                      -c "end"
          volumeMounts:
            - name: frr-config
              mountPath: /etc/frr/daemons
              subPath: daemons
            - name: frr-config
              mountPath: /etc/frr/frr.conf
              subPath: frr.conf
            - name: frr-config
              mountPath: /etc/frr/vtysh.conf
              subPath: vtysh.conf
          ports:
            - name: bgp
              containerPort: 179
      volumes:
        - name: frr-config
          configMap:
            name: frr1-config
---
apiVersion: v1
kind: Service
metadata:
  name: frr1
  namespace: network-lab
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: frr1
  ports:
    - name: bgp
      port: 179
      targetPort: 179
