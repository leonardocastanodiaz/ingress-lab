apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: argocd-allow-kubelet-probes
  namespace: argocd
spec:
  # Allow kubelet health probes from the k3d Docker node network.
  # Argo CD v3.3+ NetworkPolicies restrict ingress to pods only (namespaceSelector: {}).
  # Kubelet probes originate from the node's host network (172.20.0.0/16 on k3d/Docker),
  # not from pod namespaces, so they are blocked by default.
  podSelector: {}  # applies to all pods in the argocd namespace
  ingress:
    - from:
        - ipBlock:
            cidr: 172.20.0.0/16  # k3d Docker bridge network (node IPs)
        - ipBlock:
            cidr: 10.0.0.0/8  # Cilium host interfaces (cilium_host) - actual source of kubelet probes
  policyTypes:
    - Ingress
